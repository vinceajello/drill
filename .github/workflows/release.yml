name: Build and Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: target/x86_64-pc-windows-msvc/release/drill.exe
          - os: macos-latest
            target: aarch64-apple-darwin
            needs_packager: true
    
    runs-on: ${{ matrix.os }}
    env:
      RAW_TAG: ${{ github.ref_name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install cargo-packager (macOS only)
        if: matrix.needs_packager
        run: cargo install cargo-packager

      - name: Build Windows executable
        if: matrix.os == 'windows-latest'
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build macOS bundle
        if: matrix.os == 'macos-latest'
        run: cargo packager --release

      - name: Find .app bundle
        if: matrix.os == 'macos-latest'
        id: find_app
        run: |
          APP_PATH=$(find target/release/bundle -name "*.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Error: No .app bundle found"
            exit 1
          fi
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
          echo "Found app at: $APP_PATH"

      - name: Sign an Application Bundle
        if: matrix.os == 'macos-latest'
        uses: indygreg/apple-code-sign-action@v1
        with:
          input_path: ${{ steps.find_app.outputs.app_path }}
          output_path: ${{ steps.find_app.outputs.app_path }}

      - name: Prepare Windows artifact name
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $ver = '${{ env.RAW_TAG }}' -replace '^v',''
          $arch = 'x86_64'
          $src = "target/${{ matrix.target }}/release/drill.exe"
          $dest = "target/${{ matrix.target }}/release/drill_${ver}_${arch}.exe"
          if (Test-Path $src) { Copy-Item $src $dest } else { Write-Error "Source not found: $src"; exit 1 }
          "UPLOAD_FILE=$dest" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Prepare macOS artifact name
        if: matrix.os == 'macos-latest'
        run: |
          ver=${{ env.RAW_TAG }}
          ver=${ver#v}
          arch=$(echo "${{ matrix.target }}" | cut -d- -f1)
          
          APP_PATH=$(find target/release/bundle -name "*.app" -type d | head -n 1)
          if [ -n "$APP_PATH" ]; then
            TARBALL="target/release/bundle/drill_${ver}_macOS_${arch}.tar.gz"
            tar -czf "$TARBALL" -C "$(dirname "$APP_PATH")" "$(basename "$APP_PATH")"
            echo "TARBALL_FILE=$TARBALL" >> $GITHUB_ENV
          fi
      
      - name: Upload Windows release asset
        if: matrix.os == 'windows-latest'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.UPLOAD_FILE }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS release asset
        if: matrix.os == 'macos-latest'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.TARBALL_FILE }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

